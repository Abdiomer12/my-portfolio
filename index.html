<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Excel - Smart Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 550px; text-align: center; }
        h2 { color: #1a73e8; margin-bottom: 10px; }
        input[type="file"] { border: 2px dashed #1a73e8; padding: 25px; width: 90%; border-radius: 10px; cursor: pointer; margin-bottom: 20px; background: #f8fbff; }
        button { background-color: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
        button:hover { background-color: #218838; }
        #status { margin-top: 20px; font-weight: 500; color: #5f6368; }
        .info-box { text-align: left; background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px; color: #856404; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div class="card">
    <h2>Dhismaha Excel-ka (History)</h2>
    <p>Gali PDF-ka si uu ugu dhex daro Correct Answer-ka</p>
    
    <input type="file" id="pdfInput" accept="application/pdf">
    <button id="convertBtn">Soo saar Excel-ka Dhamaystiran</button>
    
    <div id="status"></div>

    <div class="info-box">
        <strong>Sida uu Correct Answer u helayo:</strong><br>
        • Wuxuu raadinayaa calaamadaha: <b>*</b> ama <b>(x)</b> ama <b>✓</b><br>
        • Wuxuu raadinayaa kelmadaha: <b>Answer:</b> ama <b>Ans:</b><br>
        • Haddii PDF-ku uusan calaamad lahayn, qaybtaas bannaun ayay noqonaysaa.
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    document.getElementById('convertBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('pdfInput');
        const status = document.getElementById('status');
        
        if (fileInput.files.length === 0) {
            status.innerText = "Fadlan marka hore dooro faylka!";
            return;
        }

        status.innerText = "Xogta waa laga soo saarayaa PDF-ka...";
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(" ");
                fullText += pageText + "\n";
            }
            processData(fullText);
        };
        reader.readAsArrayBuffer(file);
    });

    function processData(text) {
        // Kala jabi su'aalaha (1. 2. 3.)
        const questionBlocks = text.split(/(?=\b\d+[\.\)])/);
        const excelData = [];

        // Row-ga Madaxa ah (Sida sawirkaaga)
        excelData.push(["", "EXAM CHAPTER NINE EP2 HISTORY", "", "", "", "", ""]);
        excelData.push(["No", "Question", "Option1", "Option2", "Option3", "Option4", "CorrectAnswer"]);

        questionBlocks.forEach((block, index) => {
            if (block.trim().length < 5) return;

            let questionNum = index + 1;
            
            // Kala saar dookhyada A, B, C, D
            let parts = block.split(/(?=[A-D][\.\)\s])/); 
            let questionText = parts[0].replace(/^\d+[\.\)]\s*/, "").trim();
            
            let options = [];
            for(let i=1; i<=4; i++) {
                options.push(parts[i] ? parts[i].trim() : "");
            }

            // --- RAADINTA CORRECT ANSWER (LOGIC CUSUB) ---
            let correctAnswer = "";

            // 1. Ma leeyahay "Answer: A" dhammaadka su'aasha?
            let ansMatch = block.match(/(?:Answer|Ans|Key):\s*([A-D])/i);
            if (ansMatch) {
                let letter = ansMatch[1].toUpperCase();
                let indexMap = {'A':0, 'B':1, 'C':2, 'D':3};
                correctAnswer = options[indexMap[letter]] || letter;
            } 
            // 2. Haddii kale, miyuu dookhyada midkood leeyahay calaamad (*)?
            else {
                options.forEach(opt => {
                    if (opt.includes("*") || opt.includes("✓") || opt.includes("(x)")) {
                        correctAnswer = opt.replace(/[\*✓\(x\)]/g, "").trim();
                    }
                });
            }

            // Nadiifi dookhyada xarfaha ka saar (A. B. C. D.)
            let cleanOptions = options.map(opt => opt.replace(/^[A-D][\.\)\s]*/, "").replace(/[\*✓\(x\)]/g, "").trim());

            // Haddii CorrectAnswer weli uu xaraf yahay (sida A), u bedel qoraalkii dookhaas
            if (correctAnswer.length === 1 && "ABCD".includes(correctAnswer)) {
                let idx = "ABCD".indexOf(correctAnswer);
                correctAnswer = cleanOptions[idx];
            }

            excelData.push([
                questionNum, 
                questionText.split(/(?:Answer|Ans|Key):/i)[0].trim(), // Ka saar "Answer: A" su'aasha dhexdeeda
                cleanOptions[0], 
                cleanOptions[1], 
                cleanOptions[2], 
                cleanOptions[3], 
                correctAnswer
            ]);
        });

        saveAsExcel(excelData);
    }

    function saveAsExcel(data) {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Cabirka columns-ka
        ws['!cols'] = [{wch:5}, {wch:50}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:25}];

        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, "Exam_Updated_Result.xlsx");
        
        document.getElementById('status').innerHTML = "<span style='color:green'>✔ Excel-kii waa diyaar! Correct Answer-kana waa lagu daray.</span>";
    }
</script>

</body>
</html>
