<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Subject PDF to Excel Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f9; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 600px; text-align: center; border-top: 6px solid #007bff; }
        h2 { color: #333; margin-bottom: 5px; }
        p { color: #666; margin-bottom: 25px; }
        .upload-area { border: 2px dashed #007bff; background: #f8fbff; padding: 30px; border-radius: 15px; cursor: pointer; transition: 0.3s; margin-bottom: 20px; position: relative; }
        .upload-area:hover { background: #eef6ff; }
        input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        button { background: #007bff; color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 17px; font-weight: 600; cursor: pointer; width: 100%; box-shadow: 0 4px 15px rgba(0,123,255,0.3); }
        button:hover { background: #0056b3; }
        #status { margin-top: 20px; font-size: 14px; font-weight: 500; }
        .features { display: flex; justify-content: space-around; margin-top: 20px; font-size: 12px; color: #888; }
        .features span { background: #eee; padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Dhismaha Excel-ka (All Subjects)</h2>
    <p>U bedel PDF-kaaga (History, Maths, Arabic) qaab Excel nadiif ah</p>
    
    <div class="upload-area">
        <p id="fileName">Guji halkan ama soo jiid faylka PDF-ka</p>
        <input type="file" id="pdfInput" accept="application/pdf">
    </div>

    <button id="convertBtn">Soo saar Faylka Excel (.xlsx)</button>
    
    <div id="status"></div>

    <div class="features">
        <span>✔ Ka saarista A, B, C, D</span>
        <span>✔ Af-Carabi</span>
        <span>✔ Xisaab (Maths)</span>
        <span>✔ Correct Answer</span>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const fileInput = document.getElementById('pdfInput');
    fileInput.onchange = () => {
        document.getElementById('fileName').innerText = fileInput.files[0].name;
    };

    document.getElementById('convertBtn').addEventListener('click', async () => {
        if (fileInput.files.length === 0) {
            alert("Fadlan marka hore dooro fayl!");
            return;
        }

        const status = document.getElementById('status');
        status.innerHTML = "⏳ Waa lala soo baxayaa xogta... fadlan sug.";
        status.style.color = "#007bff";

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function() {
            try {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                let fullText = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    // Isticmaalka nidaam u fiican Carabiga iyo Math-ka
                    const pageText = textContent.items.map(item => item.str).join(" ");
                    fullText += pageText + "\n";
                }
                processExamData(fullText);
            } catch (e) {
                status.innerText = "❌ Khalad baa dhacay xilliga akhrinta PDF-ka.";
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function processExamData(text) {
        // Waxay raadinaysaa nambarka su'aasha (English: 1. ama Arabic: ١.)
        const questionBlocks = text.split(/(?=\b\d+[\.\)]|\b[\u0660-\u0669]+[\.\)])/);
        const rows = [];

        // Madaxa Excel-ka
        rows.push(["", "EXAM AUTOMATED REPORT", "", "", "", "", ""]);
        rows.push(["No", "Question", "Option 1", "Option 2", "Option 3", "Option 4", "Correct Answer"]);

        questionBlocks.forEach((block, index) => {
            if (block.trim().length < 10) return;

            // 1. Kala saar Question iyo Options (A, B, C, D)
            let parts = block.split(/(?=\b[A-D][\.\)\-\s])/i);
            let questionPart = parts[0].replace(/^[\d\u0660-\u0669]+[\.\)]\s*/, "").trim();
            
            let rawOptions = [];
            for(let i=1; i<=4; i++) {
                rawOptions.push(parts[i] ? parts[i].trim() : "");
            }

            // 2. NADIIFINTA: Ka saar "A.", "B.", "C.", "D." horgalaha ah
            let cleanOptions = rawOptions.map(opt => {
                // Regex-kani wuxuu saarayaa Xarafka + Calaamadda ka dambaysa bilowga qoraalka
                return opt.replace(/^[A-D][\.\)\-\s]*/i, "").replace(/[\*✓]/g, "").trim();
            });

            // 3. CORRECT ANSWER LOGIC
            let correctAnswer = "";
            // Raadi haddii "Answer: B" ay ku jirto su'aasha
            let keyMatch = block.match(/(?:Answer|Ans|Key|Jawaab):\s*([A-D])/i);
            
            if (keyMatch) {
                let letter = keyMatch[1].toUpperCase();
                let idx = "ABCD".indexOf(letter);
                correctAnswer = cleanOptions[idx] || letter;
            } else {
                // Haddii kale raadi calaamadda * ama ✓
                rawOptions.forEach((opt, i) => {
                    if (opt.includes("*") || opt.includes("✓")) {
                        correctAnswer = cleanOptions[i];
                    }
                });
            }

            rows.push([
                index + 1, 
                questionPart.split(/(?:Answer|Ans|Key|Jawaab):/i)[0].trim(),
                cleanOptions[0], 
                cleanOptions[1], 
                cleanOptions[2], 
                cleanOptions[3], 
                correctAnswer
            ]);
        });

        generateExcel(rows);
    }

    function generateExcel(data) {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Cabirka Columns-ka (Si ay u qaadaan qoraalka Carabiga ama Xisaabta)
        ws['!cols'] = [
            { wch: 6 },  // No
            { wch: 60 }, // Question
            { wch: 25 }, // Opt 1
            { wch: 25 }, // Opt 2
            { wch: 25 }, // Opt 3
            { wch: 25 }, // Opt 4
            { wch: 30 }  // Correct Answer
        ];

        XLSX.utils.book_append_sheet(wb, ws, "ExamResults");
        XLSX.writeFile(wb, "Final_Exam_Converted.xlsx");
        
        const status = document.getElementById('status');
        status.innerHTML = "✅ Excel-kii waa diyaar! Xogta waa la nadiifiyey.";
        status.style.color = "#28a745";
    }
</script>

</body>
</html>
